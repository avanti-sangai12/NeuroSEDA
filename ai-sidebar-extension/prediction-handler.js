// ============================================================================\n// Prediction Widget Handler\n// ============================================================================\n// Manages the display and interaction of next-element predictions\n// ============================================================================\n\nclass PredictionWidget {\n  constructor() {\n    this.widget = document.getElementById('prediction-widget');\n    this.predictionsList = document.getElementById('predictions-list');\n    this.emptyState = document.getElementById('prediction-empty');\n    this.loadingState = document.getElementById('prediction-loading');\n    this.closeBtn = document.getElementById('close-predictions');\n    \n    this.currentPredictions = [];\n    this.isVisible = false;\n    \n    this.initEventListeners();\n  }\n  \n  initEventListeners() {\n    if (this.closeBtn) {\n      this.closeBtn.addEventListener('click', () => this.hide());\n    }\n  }\n  \n  show() {\n    if (!this.widget) return;\n    this.widget.classList.remove('hidden');\n    this.isVisible = true;\n  }\n  \n  hide() {\n    if (!this.widget) return;\n    this.widget.classList.add('hidden');\n    this.isVisible = false;\n  }\n  \n  showLoading() {\n    if (!this.loadingState) return;\n    this.predictionsList.innerHTML = '';\n    this.emptyState.classList.add('hidden');\n    this.loadingState.classList.remove('hidden');\n  }\n  \n  displayPredictions(predictions) {\n    if (!this.widget) {\n      console.warn('[Predictions] Widget not found');\n      return;\n    }\n    \n    this.currentPredictions = predictions;\n    \n    if (!predictions || predictions.length === 0) {\n      this.showEmpty();\n      this.show();\n      return;\n    }\n    \n    this.predictionsList.innerHTML = '';\n    this.emptyState.classList.add('hidden');\n    this.loadingState.classList.add('hidden');\n    \n    predictions.forEach((pred, idx) => {\n      const item = this.createPredictionItem(pred);\n      this.predictionsList.appendChild(item);\n    });\n    \n    this.show();\n    console.log(`[Predictions] Displayed ${predictions.length} suggestions`);\n  }\n  \n  createPredictionItem(prediction) {\n    const item = document.createElement('div');\n    item.className = 'prediction-item';\n    item.title = prediction.reason || 'Next action suggestion';\n    \n    const actionEmoji = this.getActionEmoji(prediction.action);\n    const confidenceColor = this.getConfidenceColor(prediction.confidence);\n    \n    item.innerHTML = `\n      <div class=\"prediction-text\">\n        <span class=\"prediction-rank\">${prediction.rank}</span>\n        <strong>${actionEmoji} ${prediction.text.substring(0, 40)}</strong>\n      </div>\n      <div class=\"prediction-meta\">\n        <span class=\"prediction-action\">${prediction.action}</span>\n        <span class=\"prediction-confidence\" style=\"background: ${confidenceColor};\">\n          ${prediction.confidence}%\n        </span>\n      </div>\n      <div class=\"prediction-reason\">${prediction.reason}</div>\n    `;\n    \n    item.addEventListener('click', () => {\n      this.onPredictionSelected(prediction);\n    });\n    \n    return item;\n  }\n  \n  getActionEmoji(action) {\n    const emojiMap = {\n      'click': 'ðŸ–±ï¸',\n      'input': 'âŒ¨ï¸',\n      'select': 'ðŸ“',\n      'toggle': 'âœ…',\n      'scroll': 'â¬‡ï¸'\n    };\n    return emojiMap[action] || 'ðŸ‘†';\n  }\n  \n  getConfidenceColor(confidence) {\n    if (confidence >= 80) return 'rgba(76, 175, 80, 0.5)';\n    if (confidence >= 60) return 'rgba(255, 193, 7, 0.5)';\n    if (confidence >= 40) return 'rgba(255, 152, 0, 0.5)';\n    return 'rgba(244, 67, 54, 0.5)';\n  }\n  \n  showEmpty() {\n    this.predictionsList.innerHTML = '';\n    this.emptyState.classList.remove('hidden');\n    this.loadingState.classList.add('hidden');\n  }\n  \n  onPredictionSelected(prediction) {\n    console.log('[Predictions] User selected:', prediction);\n    \n    // Notify the content script\n    chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {\n      if (tabs[0]) {\n        chrome.tabs.sendMessage(\n          tabs[0].id,\n          {\n            type: 'PERFORM_PREDICTION',\n            prediction: prediction\n          },\n          (response) => {\n            if (chrome.runtime.lastError) {\n              console.error('[Predictions] Error:', chrome.runtime.lastError);\n            }\n          }\n        );\n      }\n    });\n  }\n}\n\n// ============================================================================\n// MESSAGE HANDLER\n// ============================================================================\n\nlet predictionWidget = null;\n\nfunction initPredictionWidget() {\n  predictionWidget = new PredictionWidget();\n  console.log('[Predictions] Widget initialized');\n}\n\n// Listen for prediction updates from content script\nchrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\n  if (request.type === 'SHOW_PREDICTIONS') {\n    if (!predictionWidget) {\n      initPredictionWidget();\n    }\n    \n    console.log('[Predictions] Received predictions:', request.predictions.length);\n    predictionWidget.displayPredictions(request.predictions);\n    sendResponse({ success: true });\n  }\n  else if (request.type === 'HIDE_PREDICTIONS') {\n    if (predictionWidget) {\n      predictionWidget.hide();\n    }\n    sendResponse({ success: true });\n  }\n  else if (request.type === 'SHOW_PREDICTION_LOADING') {\n    if (!predictionWidget) {\n      initPredictionWidget();\n    }\n    predictionWidget.showLoading();\n    sendResponse({ success: true });\n  }\n});\n\n// Initialize on load\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', initPredictionWidget);\n} else {\n  initPredictionWidget();\n}\n\nconsole.log('[Predictions] Handler loaded');\n"